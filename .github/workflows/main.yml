# .github/workflows/main.yml

name: Scrape Naver News

on:
  # ë§¤ì‹œ ì •ê°ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰ (UTC ê¸°ì¤€)
  # í•œêµ­ ì‹œê°„(KST)ì€ UTC+9 ì´ë¯€ë¡œ, 00:00 UTCëŠ” 09:00 KST ìž…ë‹ˆë‹¤.
  # ë§¤ì‹œê°„ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
  schedule:
    - cron: '0 * * * *'
  # ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìžˆë„ë¡ workflow_dispatch ì¶”ê°€
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ìž¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Python í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.4' # ì›í•˜ëŠ” íŒŒì´ì¬ ë²„ì „

      # 3. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # Playwright ì„¤ì¹˜
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install

      # 4. Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Run Python script
        env:
          # ðŸ‘‡ ì—¬ê¸°ì— ì‹œê°„ëŒ€ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
          TZ: 'Asia/Seoul' 
          # GitHub Secretsì— ì €ìž¥í•œ ê°’ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ìŠ¤í¬ë¦½íŠ¸ì— ì „ë‹¬í•©ë‹ˆë‹¤.
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python naver_news_telegram_bot_v2.py

      # 5. Run Python server and expose it
      - name: Run Python server
        run: |
          python run_server.py &
          sleep 5

      - name: Install ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null && \
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list && \
          sudo apt-get update && sudo apt-get install ngrok

      - name: Start ngrok
        run: |
          ngrok http 8000 &
          sleep 5

      - name: Display ngrok URL
        run: |
          curl http://127.0.0.1:4040/api/tunnels
